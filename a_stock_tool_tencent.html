<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A股做T小型工具</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', sans-serif;
            font-size: 14px;
            background: #f5f5f5;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #2c5aa0;
            font-size: 24px;
        }

        .main-content {
            display: flex;
            gap: 20px;
            min-height: 500px;
        }

        .left-panel {
            flex: 1;
            min-width: 400px;
        }

        .right-panel {
            flex: 2;
            min-width: 600px;
        }

        .section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            background: #fafafa;
        }

        .section-title {
            font-weight: bold;
            color: #2c5aa0;
            margin-bottom: 15px;
            font-size: 16px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 8px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #666;
        }

        .search-container {
            position: relative;
        }

        input, select, button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        input:focus {
            outline: none;
            border-color: #2c5aa0;
            box-shadow: 0 0 5px rgba(44, 90, 160, 0.3);
        }

        .stock-input {
            width: 250px;
        }

        .dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            z-index: 1000;
            display: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .dropdown-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }

        .dropdown-item:hover {
            background: #f0f0f0;
        }

        button {
            background: #2c5aa0;
            color: white;
            border: none;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 5px;
        }

        button:hover {
            background: #1e3d6f;
        }

        button.danger {
            background: #d32f2f;
        }

        button.danger:hover {
            background: #b71c1c;
        }

        button.success {
            background: #388e3c;
        }

        button.success:hover {
            background: #2e7d32;
        }

        .stock-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .stock-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stock-item:hover {
            background: #f0f0f0;
        }

        .stock-item.selected {
            background: #e3f2fd;
            border-left: 4px solid #2c5aa0;
        }

        .stock-price {
            font-weight: bold;
        }

        .price-up {
            color: #d32f2f;
        }

        .price-down {
            color: #388e3c;
        }

        .price-flat {
            color: #666;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th, td {
            padding: 8px;
            text-align: center;
            border: 1px solid #ddd;
        }

        th {
            background: #f5f5f5;
            font-weight: bold;
            color: #333;
        }

        tr:hover {
            background: #f9f9f9;
        }

        tr.selected {
            background: #e3f2fd;
        }

        .profit {
            color: #d32f2f;
        }

        .loss {
            color: #388e3c;
        }

        .status-bar {
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 4px;
            text-align: center;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .trade-form {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 10px;
            align-items: end;
            margin-bottom: 15px;
        }

        .network-status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .network-online {
            background: #4caf50;
        }

        .network-offline {
            background: #f44336;
        }

        .refresh-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .auto-refresh-checkbox {
            margin-left: 10px;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        /* 快速交易弹窗样式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border-radius: 8px;
            width: 400px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .modal-title {
            font-size: 18px;
            font-weight: bold;
            color: #2c5aa0;
        }

        .close {
            font-size: 24px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            color: #000;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-input-group {
            margin-bottom: 15px;
        }

        .modal-input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #666;
        }

        .modal-input-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .modal-footer button {
            padding: 10px 20px;
            font-size: 14px;
        }

        .stock-info {
            background: #f9f9f9;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .stock-info .current-position {
            color: #666;
            margin-top: 5px;
        }

        /* 确认对话框样式 */
        .confirm-modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .confirm-content {
            background-color: white;
            margin: 20% auto;
            padding: 20px;
            border-radius: 8px;
            width: 400px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        .confirm-message {
            margin-bottom: 20px;
            line-height: 1.5;
            color: #333;
        }

        .confirm-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>A股做T小型工具</h1>
            <div class="status-bar" id="statusBar">
                <span class="network-status" id="networkStatus"></span>
                <span id="statusText">系统就绪</span>
            </div>
        </div>

        <div class="main-content">
            <div class="left-panel">
                <div class="section">
                    <div class="section-title">添加股票</div>
                    <div class="input-group">
                        <label class="input-label">股票代码/简称</label>
                        <div class="search-container">
                            <input type="text" class="stock-input" id="stockSearch" placeholder="输入股票代码或简称搜索">
                            <div class="dropdown" id="searchDropdown"></div>
                        </div>
                        <button onclick="addStock()">添加股票</button>
                    </div>
                </div>

                <div class="section">
                    <div class="section-title">总盈亏统计</div>
                    <div id="totalPnLSummary">
                        <div style="text-align: center; color: #999; padding: 20px;">
                            暂无持仓数据
                        </div>
                    </div>
                </div>

                <div class="section">
                    <div class="section-title">关注股票列表</div>
                    <div class="refresh-controls">
                        <button onclick="refreshPrices()">手动刷新价格</button>
                        <label class="auto-refresh-checkbox">
                            <input type="checkbox" id="autoRefresh" onchange="toggleAutoRefresh()">
                            自动刷新(30秒)
                        </label>
                    </div>
                    <div class="stock-list" id="stockList">
                        <div style="padding: 20px; text-align: center; color: #999;">
                            暂无关注股票
                        </div>
                    </div>
                </div>

                <div class="section">
                    <div class="section-title">数据管理</div>
                    <button class="success" onclick="saveToExcel()">保存到Excel</button>
                    <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;" onchange="loadFromExcel()">
                    <button onclick="document.getElementById('fileInput').click()">从Excel导入</button>
                </div>
            </div>

            <div class="right-panel">
                <div class="section">
                    <div class="section-title">持仓信息</div>
                    <div id="positionInfo">
                        <p style="text-align: center; color: #999; padding: 20px;">
                            请从左侧选择股票查看持仓信息
                        </p>
                    </div>
                </div>

                <div class="section">
                    <div class="section-title">添加交易记录</div>
                    <div id="tradeForm" style="display: none;">
                        <div class="trade-form">
                            <div>
                                <label class="input-label">交易方向</label>
                                <select id="tradeDirection">
                                    <option value="buy">买入</option>
                                    <option value="sell">卖出</option>
                                </select>
                            </div>
                            <div>
                                <label class="input-label">成交股数</label>
                                <input type="number" id="tradeShares" placeholder="股数" min="1">
                            </div>
                            <div>
                                <label class="input-label">成交价格</label>
                                <input type="number" id="tradePrice" placeholder="价格" min="0" step="0.01">
                            </div>
                            <button onclick="addTrade()">添加交易</button>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <div class="section-title">交易记录</div>
                    <div id="tradeHistory">
                        <p style="text-align: center; color: #999; padding: 20px;">
                            请从左侧选择股票查看交易记录
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 快速交易弹窗 -->
    <div id="quickTradeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">快速买入</div>
                <span class="close" onclick="closeQuickTradeModal()">×</span>
            </div>
            <div class="modal-body">
                <div class="stock-info" id="modalStockInfo">
                    <div><strong id="modalStockName">股票信息</strong></div>
                    <div class="current-position" id="modalCurrentPosition">当前持仓: 0股</div>
                </div>
                <div class="modal-input-group">
                    <label for="modalShares">交易数量（股）</label>
                    <input type="number" id="modalShares" placeholder="请输入股数" min="1">
                </div>
                <div class="modal-input-group">
                    <label for="modalPrice">交易价格（元）</label>
                    <input type="number" id="modalPrice" placeholder="请输入价格" min="0" step="0.01">
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="closeQuickTradeModal()">取消</button>
                <button id="confirmTradeBtn" onclick="confirmQuickTrade()">确认交易</button>
            </div>
        </div>
    </div>

    <!-- 确认对话框 -->
    <div id="confirmModal" class="confirm-modal">
        <div class="confirm-content">
            <div class="confirm-message" id="confirmMessage"></div>
            <div class="confirm-buttons">
                <button onclick="confirmAction(false)">取消</button>
                <button class="danger" onclick="confirmAction(true)">确认</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // 全局变量
        let stocks = {}; // 存储股票数据
        let selectedStock = null; // 当前选中的股票
        let autoRefreshInterval = null; // 自动刷新定时器
        let currentQuickTradeStock = null; // 当前快速交易的股票
        let currentQuickTradeDirection = null; // 当前快速交易方向
        let confirmCallback = null; // 确认对话框回调

        // 模拟的股票数据库
        const stockDatabase = [
            {code: '000001', name: '平安银行', exchange: 'sz'},
            {code: '000002', name: '万科A', exchange: 'sz'},
            {code: '000858', name: '五粮液', exchange: 'sz'},
            {code: '002415', name: '海康威视', exchange: 'sz'},
            {code: '002594', name: '比亚迪', exchange: 'sz'},
            {code: '300059', name: '东方财富', exchange: 'sz'},
            {code: '600000', name: '浦发银行', exchange: 'sh'},
            {code: '600036', name: '招商银行', exchange: 'sh'},
            {code: '600519', name: '贵州茅台', exchange: 'sh'},
            {code: '588200', name: '科创芯片ETF', exchange: 'sh'},
            {code: '600887', name: '伊利股份', exchange: 'sh'},
            {code: '002304', name: '洋河股份', exchange: 'sz'},
            {code: '600276', name: '恒瑞医药', exchange: 'sh'},
            {code: '300750', name: '宁德时代', exchange: 'sz'},
            {code: '000725', name: '京东方A', exchange: 'sz'},
{code: '000001', name: '平安银行', exchange: 'sz'},
{code: '000002', name: '万 科A', exchange: 'sz'},
{code: '000099', name: '中信海直', exchange: 'sz'},
{code: '000157', name: '中联重科', exchange: 'sz'},
{code: '000423', name: '东阿阿胶', exchange: 'sz'},
{code: '000425', name: '徐工机械', exchange: 'sz'},
{code: '000430', name: 'ST张家界', exchange: 'sz'},
{code: '000503', name: '国新健康', exchange: 'sz'},
{code: '000516', name: '国际医学', exchange: 'sz'},
{code: '000538', name: '云南白药', exchange: 'sz'},
{code: '000560', name: '我爱我家', exchange: 'sz'},
{code: '000568', name: '泸州老窖', exchange: 'sz'},
{code: '000610', name: '西安旅游', exchange: 'sz'},
{code: '000617', name: '中油资本', exchange: 'sz'},
{code: '000620', name: '盈新发展', exchange: 'sz'},
{code: '000651', name: '格力电器', exchange: 'sz'},
{code: '000656', name: '*ST金科', exchange: 'sz'},
{code: '000680', name: '山推股份', exchange: 'sz'},
{code: '000681', name: '视觉中国', exchange: 'sz'},
{code: '000712', name: '锦龙股份', exchange: 'sz'},
{code: '000716', name: '黑芝麻', exchange: 'sz'},
{code: '000725', name: '京东方A', exchange: 'sz'},
{code: '000737', name: '北方铜业', exchange: 'sz'},
{code: '000736', name: '*ST中地', exchange: 'sz'},
{code: '000766', name: '通化金马', exchange: 'sz'},
{code: '000768', name: '中航西飞', exchange: 'sz'},
{code: '000801', name: '四川九洲', exchange: 'sz'},
{code: '000880', name: '潍柴重机', exchange: 'sz'},
{code: '000895', name: '双汇发展', exchange: 'sz'},
{code: '000938', name: '紫光股份', exchange: 'sz'},
{code: '000980', name: '众泰汽车', exchange: 'sz'},
{code: '000983', name: '山西焦煤', exchange: 'sz'},
{code: '000999', name: '华润三九', exchange: 'sz'},
{code: '001965', name: '招商公路', exchange: 'sz'},
{code: '002050', name: '三花智控', exchange: 'sz'},
{code: '002142', name: '宁波银行', exchange: 'sz'},
{code: '002156', name: '通富微电', exchange: 'sz'},
{code: '002222', name: '福晶科技', exchange: 'sz'},
{code: '002229', name: '鸿博股份', exchange: 'sz'},
{code: '002253', name: '*ST智胜', exchange: 'sz'},
{code: '002271', name: '东方雨虹', exchange: 'sz'},
{code: '002292', name: '奥飞娱乐', exchange: 'sz'},
{code: '002312', name: '川发龙蟒', exchange: 'sz'},
{code: '002368', name: '太极股份', exchange: 'sz'},
{code: '002371', name: '北方华创', exchange: 'sz'},
{code: '002400', name: '省广集团', exchange: 'sz'},
{code: '002402', name: '和而泰', exchange: 'sz'},
{code: '002446', name: '盛路通信', exchange: 'sz'},
{code: '002456', name: '欧菲光', exchange: 'sz'},
{code: '002463', name: '沪电股份', exchange: 'sz'},
{code: '002484', name: '江海股份', exchange: 'sz'},
{code: '002487', name: '大金重工', exchange: 'sz'},
{code: '002517', name: '恺英网络', exchange: 'sz'},
{code: '002539', name: '云图控股', exchange: 'sz'},
{code: '002553', name: '南方精工', exchange: 'sz'},
{code: '002583', name: '海能达', exchange: 'sz'},
{code: '002594', name: '比亚迪', exchange: 'sz'},
{code: '002640', name: '跨境通', exchange: 'sz'},
{code: '002670', name: '国盛金控', exchange: 'sz'},
{code: '002709', name: '天赐材料', exchange: 'sz'},
{code: '002717', name: 'ST岭南', exchange: 'sz'},
{code: '002812', name: '恩捷股份', exchange: 'sz'},
{code: '002851', name: '麦格米特', exchange: 'sz'},
{code: '002900', name: '哈三联', exchange: 'sz'},
{code: '002922', name: '伊戈尔', exchange: 'sz'},
{code: '002902', name: '铭普光磁', exchange: 'sz'},
{code: '300002', name: '神州泰岳', exchange: 'sz'},
{code: '300015', name: '爱尔眼科', exchange: 'sz'},
{code: '300017', name: '网宿科技', exchange: 'sz'},
{code: '300037', name: '新宙邦', exchange: 'sz'},
{code: '300046', name: '台基股份', exchange: 'sz'},
{code: '300052', name: 'ST中青宝', exchange: 'sz'},
{code: '300059', name: '东方财富', exchange: 'sz'},
{code: '300122', name: '智飞生物', exchange: 'sz'},
{code: '300124', name: '汇川技术', exchange: 'sz'},
{code: '300127', name: '银河磁体', exchange: 'sz'},
{code: '300146', name: '汤臣倍健', exchange: 'sz'},
{code: '300166', name: '东方国信', exchange: 'sz'},
{code: '300170', name: '汉得信息', exchange: 'sz'},
{code: '300223', name: '北京君正', exchange: 'sz'},
{code: '300226', name: '上海钢联', exchange: 'sz'},
{code: '300274', name: '阳光电源', exchange: 'sz'},
{code: '300296', name: '利亚德', exchange: 'sz'},
{code: '300308', name: '中际旭创', exchange: 'sz'},
{code: '300315', name: '掌趣科技', exchange: 'sz'},
{code: '300353', name: '东土科技', exchange: 'sz'},
{code: '300364', name: '中文在线', exchange: 'sz'},
{code: '300374', name: '中铁装配', exchange: 'sz'},
{code: '300377', name: '赢时胜', exchange: 'sz'},
{code: '300394', name: '天孚通信', exchange: 'sz'},
{code: '300404', name: '博济医药', exchange: 'sz'},
{code: '300433', name: '蓝思科技', exchange: 'sz'},
{code: '300443', name: '金雷股份', exchange: 'sz'},
{code: '300474', name: '景嘉微', exchange: 'sz'},
{code: '300475', name: '香农芯创', exchange: 'sz'},
{code: '300476', name: '胜宏科技', exchange: 'sz'},
{code: '300502', name: '新易盛', exchange: 'sz'},
{code: '300570', name: '太辰光', exchange: 'sz'},
{code: '300576', name: '容大感光', exchange: 'sz'},
{code: '300607', name: '拓斯达', exchange: 'sz'},
{code: '300624', name: '万兴科技', exchange: 'sz'},
{code: '300678', name: '中科信息', exchange: 'sz'},
{code: '300699', name: '光威复材', exchange: 'sz'},
{code: '300719', name: '安达维尔', exchange: 'sz'},
{code: '300750', name: '宁德时代', exchange: 'sz'},
{code: '300757', name: '罗博特科', exchange: 'sz'},
{code: '300769', name: '德方纳米', exchange: 'sz'},
{code: '300788', name: '中信出版', exchange: 'sz'},
{code: '300803', name: '指南针', exchange: 'sz'},
{code: '300845', name: '捷安高科', exchange: 'sz'},
{code: '300866', name: '安克创新', exchange: 'sz'},
{code: '300881', name: '盛德鑫泰', exchange: 'sz'},
{code: '300894', name: '火星人', exchange: 'sz'},
{code: '300913', name: '兆龙互连', exchange: 'sz'},
{code: '300896', name: '爱美客', exchange: 'sz'},
{code: '300094', name: '国联水产', exchange: 'sz'},
{code: '301169', name: '零点有数', exchange: 'sz'},
{code: '301205', name: '联特科技', exchange: 'sz'},
{code: '301269', name: '华大九天', exchange: 'sz'},
{code: '301302', name: '华如科技', exchange: 'sz'},
{code: '301368', name: '丰立智能', exchange: 'sz'},
{code: '301508', name: '中机认检', exchange: 'sz'},
{code: '301592', name: '六九一二', exchange: 'sz'},
{code: '301602', name: '超研股份', exchange: 'sz'},
{code: '301628', name: '强达电路', exchange: 'sz'},
{code: '600006', name: '东风股份', exchange: 'sh'},
{code: '600009', name: '上海机场', exchange: 'sh'},
{code: '600028', name: '中国石化', exchange: 'sh'},
{code: '600030', name: '中信证券', exchange: 'sh'},
{code: '600031', name: '三一重工', exchange: 'sh'},
{code: '600036', name: '招商银行', exchange: 'sh'},
{code: '600048', name: '保利发展', exchange: 'sh'},
{code: '600050', name: '中国联通', exchange: 'sh'},
{code: '600060', name: '海信视像', exchange: 'sh'},
{code: '600104', name: '上汽集团', exchange: 'sh'},
{code: '600123', name: '兰花科创', exchange: 'sh'},
{code: '600129', name: '太极集团', exchange: 'sh'},
{code: '600132', name: '重庆啤酒', exchange: 'sh'},
{code: '600157', name: '永泰能源', exchange: 'sh'},
{code: '600188', name: '兖矿能源', exchange: 'sh'},
{code: '600266', name: '城建发展', exchange: 'sh'},
{code: '600318', name: '新力金融', exchange: 'sh'},
{code: '600326', name: '西藏天路', exchange: 'sh'},
{code: '600345', name: '长江通信', exchange: 'sh'},
{code: '600362', name: '江西铜业', exchange: 'sh'},
{code: '600363', name: '联创光电', exchange: 'sh'},
{code: '600372', name: '中航机载', exchange: 'sh'},
{code: '600373', name: '中文传媒', exchange: 'sh'},
{code: '600406', name: '国电南瑞', exchange: 'sh'},
{code: '600418', name: '江淮汽车', exchange: 'sh'},
{code: '600489', name: '中金黄金', exchange: 'sh'},
{code: '600506', name: '统一股份', exchange: 'sh'},
{code: '600519', name: '贵州茅台', exchange: 'sh'},
{code: '600522', name: '中天科技', exchange: 'sh'},
{code: '600571', name: '信雅达', exchange: 'sh'},
{code: '600584', name: '长电科技', exchange: 'sh'},
{code: '600588', name: '用友网络', exchange: 'sh'},
{code: '600595', name: '中孚实业', exchange: 'sh'},
{code: '600600', name: '青岛啤酒', exchange: 'sh'},
{code: '600616', name: '金枫酒业', exchange: 'sh'},
{code: '600619', name: '海立股份', exchange: 'sh'},
{code: '600621', name: '华鑫股份', exchange: 'sh'},
{code: '600622', name: '光大嘉宝', exchange: 'sh'},
{code: '600679', name: '上海凤凰', exchange: 'sh'},
{code: '600702', name: '舍得酒业', exchange: 'sh'},
{code: '600705', name: '中航产融', exchange: 'sh'},
{code: '600733', name: '北汽蓝谷', exchange: 'sh'},
{code: '600745', name: '闻泰科技', exchange: 'sh'},
{code: '600760', name: '中航沈飞', exchange: 'sh'},
{code: '600809', name: '山西汾酒', exchange: 'sh'},
{code: '600822', name: '上海物贸', exchange: 'sh'},
{code: '600837', name: '海通证券', exchange: 'sh'},
{code: '600887', name: '伊利股份', exchange: 'sh'},
{code: '600895', name: '张江高科', exchange: 'sh'},
{code: '600900', name: '长江电力', exchange: 'sh'},
{code: '600919', name: '江苏银行', exchange: 'sh'},
{code: '600930', name: '华电新能', exchange: 'sh'},
{code: '600938', name: '中国海油', exchange: 'sh'},
{code: '600941', name: '中国移动', exchange: 'sh'},
{code: '600946', name: '普元信息', exchange: 'sh'},
{code: '600549', name: '厦门钨业', exchange: 'sh'},
{code: '601012', name: '隆基绿能', exchange: 'sh'},
{code: '601058', name: '赛轮轮胎', exchange: 'sh'},
{code: '601061', name: '中信金属', exchange: 'sh'},
{code: '601066', name: '中信建投', exchange: 'sh'},
{code: '601088', name: '中国神华', exchange: 'sh'},
{code: '601099', name: '太平洋', exchange: 'sh'},
{code: '601127', name: '赛力斯', exchange: 'sh'},
{code: '601136', name: '首创证券', exchange: 'sh'},
{code: '601138', name: '工业富联', exchange: 'sh'},
{code: '601162', name: '天风证券', exchange: 'sh'},
{code: '601179', name: '中国西电', exchange: 'sh'},
{code: '601186', name: '中国铁建', exchange: 'sh'},
{code: '601236', name: '红塔证券', exchange: 'sh'},
{code: '601318', name: '中国平安', exchange: 'sh'},
{code: '601319', name: '中国人保', exchange: 'sh'},
{code: '601328', name: '交通银行', exchange: 'sh'},
{code: '601336', name: '新华保险', exchange: 'sh'},
{code: '601390', name: '中国中铁', exchange: 'sh'},
{code: '601398', name: '工商银行', exchange: 'sh'},
{code: '601601', name: '中国太保', exchange: 'sh'},
{code: '601628', name: '中国人寿', exchange: 'sh'},
{code: '601658', name: '邮储银行', exchange: 'sh'},
{code: '601666', name: '平煤股份', exchange: 'sh'},
{code: '601689', name: '拓普集团', exchange: 'sh'},
{code: '601698', name: '中国卫通', exchange: 'sh'},
{code: '601699', name: '潞安环能', exchange: 'sh'},
{code: '601766', name: '中国中车', exchange: 'sh'},
{code: '601788', name: '光大证券', exchange: 'sh'},
{code: '601800', name: '中国交建', exchange: 'sh'},
{code: '601816', name: '京沪高铁', exchange: 'sh'},
{code: '601858', name: '中国科传', exchange: 'sh'},
{code: '601881', name: '中国银河', exchange: 'sh'},
{code: '601899', name: '紫金矿业', exchange: 'sh'},
{code: '601916', name: '浙商银行', exchange: 'sh'},
{code: '601919', name: '中远海控', exchange: 'sh'},
{code: '601939', name: '建设银行', exchange: 'sh'},
{code: '601966', name: '玲珑轮胎', exchange: 'sh'},
{code: '601988', name: '中国银行', exchange: 'sh'},
{code: '601998', name: '中信银行', exchange: 'sh'},
{code: '603000', name: '人民网', exchange: 'sh'},
{code: '603019', name: '中科曙光', exchange: 'sh'},
{code: '603077', name: '和邦生物', exchange: 'sh'},
{code: '603083', name: '剑桥科技', exchange: 'sh'},
{code: '603087', name: '日李药业', exchange: 'sh'},
{code: '603198', name: '迎驾贡酒', exchange: 'sh'},
{code: '603220', name: '中贝通信', exchange: 'sh'},
{code: '603236', name: '移远通信', exchange: 'sh'},
{code: '603259', name: '药明康德', exchange: 'sh'},
{code: '603283', name: '赛腾股份', exchange: 'sh'},
{code: '603288', name: '海天味业', exchange: 'sh'},
{code: '603366', name: '日出东方', exchange: 'sh'},
{code: '603369', name: '今世缘', exchange: 'sh'},
{code: '603395', name: '红四方', exchange: 'sh'},
{code: '603501', name: '豪威集团', exchange: 'sh'},
{code: '603556', name: '海兴电力', exchange: 'sh'},
{code: '603605', name: '珀莱雅', exchange: 'sh'},
{code: '603662', name: '柯力传感', exchange: 'sh'},
{code: '603728', name: '鸣志电器', exchange: 'sh'},
{code: '603767', name: '中马传动', exchange: 'sh'},
{code: '603823', name: '百合花', exchange: 'sh'},
{code: '603885', name: '吉祥航空', exchange: 'sh'},
{code: '603928', name: '兴业股份', exchange: 'sh'},
{code: '603955', name: '大千生态', exchange: 'sh'},
{code: '603960', name: '克来机电', exchange: 'sh'},
{code: '603986', name: '兆易创新', exchange: 'sh'},
{code: '604000', name: '中信金属', exchange: 'sh'},
{code: '605117', name: '德业股份', exchange: 'sh'},
{code: '605577', name: '龙版传媒', exchange: 'sh'},
{code: '688008', name: '澜起科技', exchange: 'sh'},
{code: '688012', name: '中微公司', exchange: 'sh'},
{code: '688017', name: '绿的谐波', exchange: 'sh'},
{code: '688041', name: '海光信息', exchange: 'sh'},
{code: '688072', name: '拓荆科技', exchange: 'sh'},
{code: '688082', name: '盛美上海', exchange: 'sh'},
{code: '688111', name: '金山办公', exchange: 'sh'},
{code: '688166', name: '博瑞医药', exchange: 'sh'},
{code: '688256', name: '寒武纪-U', exchange: 'sh'},
{code: '688297', name: '中无人机', exchange: 'sh'},
{code: '688322', name: '奥比中光-UW', exchange: 'sh'},
{code: '688347', name: '华虹公司', exchange: 'sh'},
{code: '688390', name: '固德威', exchange: 'sh'},
{code: '688400', name: '凌云光', exchange: 'sh'},
{code: '688409', name: '富创精密', exchange: 'sh'},
{code: '688525', name: '佰维存储', exchange: 'sh'},
{code: '688605', name: '先锋精科', exchange: 'sh'},
{code: '688631', name: '莱斯信息', exchange: 'sh'},
{code: '688981', name: '中芯国际', exchange: 'sh'},
{code: '689009', name: '九号公司-WD', exchange: 'sh'},
{code: '873167', name: '新赣江', exchange: 'bj'},
{code: '159509', name: '纳指科技ETF', exchange: 'sz'},
{code: '159638', name: '高端装备ETF', exchange: 'sz'},
{code: '159740', name: '恒生科技ETF', exchange: 'sz'},
{code: '512400', name: '有色金属ETF', exchange: 'sh'},
{code: '512690', name: '酒ETF', exchange: 'sh'},
{code: '512710', name: '军工龙头ETF', exchange: 'sh'},
{code: '512760', name: '芯片ETF', exchange: 'sh'},
{code: '513090', name: '香港证券ETF', exchange: 'sh'},
{code: '513180', name: '恒生科技指数E...', exchange: 'sh'},
{code: '513770', name: '港股互联网ETF', exchange: 'sh'},
{code: '515790', name: '光伏ETF', exchange: 'sh'},
{code: '518880', name: '黄金ETF', exchange: 'sh'},
{code: '561980', name: '半导体设备ETF', exchange: 'sz'},
{code: '563300', name: '中证2000ETF', exchange: 'sh'},
{code: '588080', name: '科创板50ETF', exchange: 'sh'},
{code: '588200', name: '科创芯片ETF', exchange: 'sh'},
{code: 'HK1347', name: '华虹半导体', exchange: 'hk'},
{code: 'HK1810', name: '小米集团-W', exchange: 'hk'},
{code: 'HK2015', name: '理想汽车-W', exchange: 'hk'},
{code: 'HK2423', name: '贝壳-W', exchange: 'hk'},
{code: 'HK2498', name: '速腾聚创', exchange: 'hk'},
{code: 'HK6186', name: '中国飞鹤', exchange: 'hk'},
{code: 'HK6881', name: '中国银河', exchange: 'hk'},
{code: 'HK9988', name: '阿里巴巴-W', exchange: 'hk'}
        ];

// 去重股票数据库（按股票代码去重，保留第一次出现的）
const uniqueStockDatabase = Array.from(
    new Map(stockDatabase.map(item => [item.code, item])).values()
);
stockDatabase.length = 0;
stockDatabase.push(...uniqueStockDatabase);


        // 自定义确认对话框
        function showConfirm(message, callback) {
            const modal = document.getElementById('confirmModal');
            const messageElement = document.getElementById('confirmMessage');
            messageElement.innerHTML = message.replace(/\n/g, '<br>');
            confirmCallback = callback;
            modal.style.display = 'block';
        }

        function confirmAction(result) {
            const modal = document.getElementById('confirmModal');
            modal.style.display = 'none';
            if (confirmCallback) {
                confirmCallback(result);
                confirmCallback = null;
            }
        }

        // 简单的本地存储替代方案（使用变量存储）
        let localData = {};

        function saveToStorage() {
            try {
                // 尝试使用 localStorage，如果失败则使用内存存储
                if (typeof Storage !== "undefined") {
                    localStorage.setItem('aStockTrading', JSON.stringify(stocks));
                } else {
                    localData.aStockTrading = JSON.stringify(stocks);
                }
            } catch (error) {
                // 沙盒环境下使用内存存储
                localData.aStockTrading = JSON.stringify(stocks);
                console.log('使用内存存储模式');
            }
        }

        function loadFromStorage() {
            try {
                let saved = null;
                if (typeof Storage !== "undefined") {
                    saved = localStorage.getItem('aStockTrading');
                } else {
                    saved = localData.aStockTrading;
                }
                
                if (saved) {
                    stocks = JSON.parse(saved);
                    updateStockList();
                }
            } catch (error) {
                // 在沙盒环境下，使用空数据开始
                stocks = {};
                console.log('使用新数据开始');
            }
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            setupSearchInput();
            loadFromStorage();
            showStatus('系统就绪', 'success');
        });

        // 设置搜索输入框
        function setupSearchInput() {
            const searchInput = document.getElementById('stockSearch');
            const dropdown = document.getElementById('searchDropdown');

            searchInput.addEventListener('input', function(e) {
                const query = e.target.value.trim();
                if (query.length >= 1) {
                    showSearchResults(query);
                } else {
                    hideDropdown();
                }
            });

            searchInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addStock();
                }
            });

            // 延迟隐藏下拉菜单，给点击事件时间执行
            searchInput.addEventListener('blur', function() {
                setTimeout(() => hideDropdown(), 150);
            });
        }

        // 显示搜索结果
        function showSearchResults(query) {
            const dropdown = document.getElementById('searchDropdown');
            const results = stockDatabase.filter(stock => 
                stock.code.toLowerCase().includes(query.toLowerCase()) || 
                stock.name.toLowerCase().includes(query.toLowerCase())
            ).slice(0, 10);

            if (results.length > 0) {
                dropdown.innerHTML = results.map(stock => 
                    `<div class="dropdown-item" onclick="selectStock('${stock.code}', '${stock.name}')">${stock.code} - ${stock.name}</div>`
                ).join('');
                dropdown.style.display = 'block';
            } else {
                dropdown.innerHTML = '<div class="dropdown-item" style="color: #999; cursor: default;">没有找到匹配的股票</div>';
                dropdown.style.display = 'block';
            }
        }

        // 隐藏下拉菜单
        function hideDropdown() {
            const dropdown = document.getElementById('searchDropdown');
            dropdown.style.display = 'none';
        }

        // 选择股票
        function selectStock(code, name) {
            document.getElementById('stockSearch').value = `${code} - ${name}`;
            hideDropdown();
        }

        // 添加股票到关注列表
        function addStock() {
            const input = document.getElementById('stockSearch');
            const value = input.value.trim();
            
            if (!value) {
                showStatus('请输入股票代码或简称', 'error');
                return;
            }

            let stockInfo = null;
            
            // 从输入中解析股票信息
            if (value.includes(' - ')) {
                const parts = value.split(' - ');
                if (parts.length >= 2) {
                    stockInfo = {code: parts[0].trim(), name: parts[1].trim()};
                }
            } else {
                // 在数据库中查找
                stockInfo = stockDatabase.find(stock => 
                    stock.code.toLowerCase() === value.toLowerCase() || 
                    stock.name.toLowerCase() === value.toLowerCase()
                );
            }

            if (!stockInfo) {
                showStatus('股票代码或简称不存在，请从下拉列表中选择', 'error');
                return;
            }

            if (stocks[stockInfo.code]) {
                showStatus('股票已在关注列表中', 'warning');
                return;
            }

            // 添加股票
            stocks[stockInfo.code] = {
                code: stockInfo.code,
                name: stockInfo.name,
                price: '---',
                position: 0,
                cost: 0,
                trades: [],
                realizedPnL: 0
            };

            input.value = '';
            updateStockList();
            showStatus(`已添加 ${stockInfo.code} - ${stockInfo.name}`, 'success');
            saveToStorage();
        }

        // 显示状态信息
        function showStatus(message, type) {
            const statusBar = document.getElementById('statusBar');
            const statusText = document.getElementById('statusText');
            
            statusText.textContent = message;
            statusBar.className = 'status-bar status-' + type;
            
            // 自动清除状态信息
            setTimeout(() => {
                if (statusText.textContent === message) {
                    statusText.textContent = '系统就绪';
                    statusBar.className = 'status-bar status-success';
                }
            }, 3000);
        }

        // 获取价格样式类
        function getPriceClass(price) {
            if (price === '---') return 'price-flat';
            const priceNum = parseFloat(price);
            if (priceNum >= 100) return 'price-up';
            if (priceNum <= 20) return 'price-down';
            return 'price-flat';
        }

        // 更新股票列表显示
        function updateStockList() {
            const stockList = document.getElementById('stockList');
            
            if (Object.keys(stocks).length === 0) {
                stockList.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">暂无关注股票</div>';
                updateTotalPnLSummary();
                return;
            }

            stockList.innerHTML = Object.keys(stocks).map(code => {
                const stock = stocks[code];
                const selected = selectedStock === code ? 'selected' : '';
                const priceClass = getPriceClass(stock.price);
                
                return `
                    <div class="stock-item ${selected}" onclick="selectStockItem('${code}')">
                        <div style="flex: 1;">
                            <div style="margin-bottom: 5px;">
                                <strong>${code}</strong> - ${stock.name}
                                <span class="stock-price ${priceClass}" style="margin-left: 10px;">${stock.price}</span>
                            </div>
                            <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                                <button class="success" onclick="event.stopPropagation(); quickBuy('${code}')" style="margin: 0; padding: 3px 8px; font-size: 11px;">买入</button>
                                <button class="danger" onclick="event.stopPropagation(); quickSell('${code}')" style="margin: 0; padding: 3px 8px; font-size: 11px;">卖出</button>
                                <button class="danger" onclick="event.stopPropagation(); removeStock('${code}')" style="margin: 0; padding: 3px 8px; font-size: 11px;">删除</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            updateTotalPnLSummary();
        }

        // 选择股票项
        function selectStockItem(code) {
            selectedStock = code;
            updateStockList();
            updatePositionInfo();
            updateTradeHistory();
            showTradeForm();
        }

        // 删除股票
        function removeStock(code) {
            if (!stocks[code]) {
                showStatus('股票不存在', 'error');
                return;
            }
            
            const stock = stocks[code];
            const tradeCount = stock.trades.length;
            
            let confirmMessage = `确定要删除 ${stock.name} (${code}) 吗？\n\n`;
            confirmMessage += `将会删除：\n`;
            confirmMessage += `• 当前持仓：${stock.position}股\n`;
            confirmMessage += `• 已实现盈亏：${stock.realizedPnL.toFixed(2)}元\n`;
            confirmMessage += `• ${tradeCount}条交易记录\n\n`;
            confirmMessage += `此操作不可撤销！`;
            
            showConfirm(confirmMessage, function(confirmed) {
                if (confirmed) {
                    delete stocks[code];
                    if (selectedStock === code) {
                        selectedStock = null;
                        hideTradeForm();
                        updatePositionInfo();
                        updateTradeHistory();
                    }
                    updateStockList();
                    showStatus(`已删除股票 ${stock.name} 及其所有数据`, 'success');
                    saveToStorage();
                }
            });
        }

        // 刷新价格
        async function refreshPrices() {
            if (Object.keys(stocks).length === 0) {
                showStatus('没有需要刷新的股票', 'warning');
                return;
            }

            const refreshBtn = document.querySelector('button[onclick="refreshPrices()"]');
            const originalText = refreshBtn.textContent;
            refreshBtn.textContent = '刷新中...';
            refreshBtn.disabled = true;

            try {
                showStatus('正在刷新价格...', 'warning');
                await batchGetPrices();
                updateStockList();
                updatePositionInfo();
                showStatus(`已刷新${Object.keys(stocks).length}只股票价格`, 'success');
            } catch (error) {
                showStatus('价格刷新失败: ' + error.message, 'error');
            } finally {
                refreshBtn.textContent = originalText;
                refreshBtn.disabled = false;
            }
        }

        // 模拟获取股票价格
        async function getStockPrice(code) {
            await new Promise(resolve => setTimeout(resolve, 100 + Math.random() * 200));
            
            let basePrice;
            switch(code) {
                case '600519': basePrice = 1800 + Math.random() * 200; break;
                case '000858': basePrice = 200 + Math.random() * 50; break;
                case '600036': basePrice = 35 + Math.random() * 10; break;
                case '000002': basePrice = 18 + Math.random() * 5; break;
                case '002415': basePrice = 45 + Math.random() * 15; break;
                case '002594': basePrice = 250 + Math.random() * 80; break;
                case '300750': basePrice = 450 + Math.random() * 100; break;
                default: basePrice = 10 + Math.random() * 40; break;
            }
            
            const changePercent = (Math.random() - 0.5) * 0.04;
            const finalPrice = basePrice * (1 + changePercent);
            return finalPrice.toFixed(2);
        }

        // 批量获取股票价格
        async function batchGetPrices() {
            const codes = Object.keys(stocks);
            const promises = codes.map(async code => {
                try {
                    const price = await getStockPrice(code);
                    stocks[code].price = price;
                } catch (error) {
                    console.error(`获取${code}价格失败:`, error);
                }
            });
            await Promise.all(promises);
        }

        // 切换自动刷新
        function toggleAutoRefresh() {
            const checkbox = document.getElementById('autoRefresh');
            
            if (checkbox.checked) {
                autoRefreshInterval = setInterval(refreshPrices, 30000);
                showStatus('已开启自动刷新(30秒)', 'success');
            } else {
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
                showStatus('已关闭自动刷新', 'warning');
            }
        }

        // 显示交易表单
        function showTradeForm() {
            document.getElementById('tradeForm').style.display = 'block';
        }

        // 隐藏交易表单
        function hideTradeForm() {
            document.getElementById('tradeForm').style.display = 'none';
        }

        // 添加交易记录
        function addTrade() {
            if (!selectedStock) {
                showStatus('请先选择股票', 'error');
                return;
            }

            const direction = document.getElementById('tradeDirection').value;
            const shares = parseInt(document.getElementById('tradeShares').value);
            const price = parseFloat(document.getElementById('tradePrice').value);

            if (!shares || shares <= 0) {
                showStatus('请输入正确的股数', 'error');
                return;
            }

            if (!price || price <= 0) {
                showStatus('请输入正确的价格', 'error');
                return;
            }

            const stock = stocks[selectedStock];

            if (direction === 'sell' && shares > stock.position) {
                showStatus(`卖出股数(${shares})不能超过当前持仓(${stock.position})`, 'error');
                return;
            }

            const trade = {
                id: Date.now() + Math.random(),
                direction: direction,
                shares: shares,
                price: price,
                time: new Date().toLocaleString()
            };

            stock.trades.push(trade);
            calculatePosition(selectedStock);

            document.getElementById('tradeShares').value = '';
            document.getElementById('tradePrice').value = '';

            updatePositionInfo();
            updateTradeHistory();
            updateStockList();
            showStatus(`交易记录已添加`, 'success');
            saveToStorage();
        }

        // 计算持仓
        function calculatePosition(code) {
            const stock = stocks[code];
            let position = 0;
            let totalCost = 0;
            let realizedPnL = 0;
            
            const trades = [...stock.trades].sort((a, b) => new Date(a.time) - new Date(b.time));
            
            for (const trade of trades) {
                if (trade.direction === 'buy') {
                    position += trade.shares;
                    totalCost += trade.shares * trade.price;
                } else if (trade.direction === 'sell') {
                    if (position > 0) {
                        const avgCost = totalCost / position;
                        const soldValue = trade.shares * trade.price;
                        const soldCost = trade.shares * avgCost;
                        realizedPnL += soldValue - soldCost;
                        
                        position -= trade.shares;
                        totalCost -= soldCost;
                    }
                }
            }
            
            stock.position = position;
            stock.cost = position > 0 ? totalCost / position : 0;
            stock.realizedPnL = realizedPnL;
        }

        // 更新持仓信息
        function updatePositionInfo() {
            const positionInfo = document.getElementById('positionInfo');
            
            if (!selectedStock || !stocks[selectedStock]) {
                positionInfo.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">请从左侧选择股票查看持仓信息</p>';
                return;
            }
            
            const stock = stocks[selectedStock];
            const currentPrice = parseFloat(stock.price) || 0;
            const unrealizedPnL = stock.position * (currentPrice - stock.cost);
            const totalPnL = stock.realizedPnL + unrealizedPnL;
            
            positionInfo.innerHTML = `
                <div style="padding: 15px; background: #f9f9f9; border-radius: 4px;">
                    <h3 style="margin-bottom: 15px; color: #2c5aa0;">${stock.code} - ${stock.name}</h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                        <div>
                            <div style="margin-bottom: 8px;"><strong>当前持仓：</strong>${stock.position}股</div>
                            <div style="margin-bottom: 8px;"><strong>持仓成本：</strong>¥${stock.cost.toFixed(2)}</div>
                            <div style="margin-bottom: 8px;"><strong>当前价格：</strong>¥${stock.price}</div>
                        </div>
                        <div>
                            <div style="margin-bottom: 8px;"><strong>持仓市值：</strong>¥${(stock.position * currentPrice).toFixed(2)}</div>
                            <div style="margin-bottom: 8px;"><strong>已实现盈亏：</strong><span class="${stock.realizedPnL >= 0 ? 'profit' : 'loss'}">¥${stock.realizedPnL.toFixed(2)}</span></div>
                            <div style="margin-bottom: 8px;"><strong>未实现盈亏：</strong><span class="${unrealizedPnL >= 0 ? 'profit' : 'loss'}">¥${unrealizedPnL.toFixed(2)}</span></div>
                            <div style="margin-bottom: 8px;"><strong>总盈亏：</strong><span class="${totalPnL >= 0 ? 'profit' : 'loss'}">¥${totalPnL.toFixed(2)}</span></div>
                        </div>
                    </div>
                </div>
            `;
        }

        // 更新交易记录
        function updateTradeHistory() {
            const tradeHistory = document.getElementById('tradeHistory');
            
            if (!selectedStock || !stocks[selectedStock]) {
                tradeHistory.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">请从左侧选择股票查看交易记录</p>';
                return;
            }
            
            const stock = stocks[selectedStock];
            
            if (stock.trades.length === 0) {
                tradeHistory.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">暂无交易记录</p>';
                return;
            }
            
            const sortedTrades = [...stock.trades].sort((a, b) => new Date(b.time) - new Date(a.time));
            
            tradeHistory.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>时间</th>
                            <th>方向</th>
                            <th>股数</th>
                            <th>价格</th>
                            <th>金额</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${sortedTrades.map(trade => `
                            <tr>
                                <td>${trade.time}</td>
                                <td style="color: ${trade.direction === 'buy' ? '#d32f2f' : '#388e3c'}">
                                    ${trade.direction === 'buy' ? '买入' : '卖出'}
                                </td>
                                <td>${trade.shares}</td>
                                <td>¥${trade.price.toFixed(2)}</td>
                                <td>¥${(trade.shares * trade.price).toFixed(2)}</td>
                                <td>
                                    <button class="danger" onclick="deleteTrade('${selectedStock}', '${trade.id}')" style="margin: 0; padding: 2px 6px; font-size: 11px;">删除</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // 删除交易记录
        function deleteTrade(stockCode, tradeId) {
            showConfirm('确定要删除这条交易记录吗？', function(confirmed) {
                if (confirmed) {
                    const stock = stocks[stockCode];
                    stock.trades = stock.trades.filter(trade => trade.id !== tradeId);
                    calculatePosition(stockCode);
                    updatePositionInfo();
                    updateTradeHistory();
                    updateStockList();
                    showStatus('交易记录已删除', 'success');
                    saveToStorage();
                }
            });
        }

        // 更新总盈亏统计
        function updateTotalPnLSummary() {
            const totalPnLSummary = document.getElementById('totalPnLSummary');
            
            if (Object.keys(stocks).length === 0) {
                totalPnLSummary.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">暂无持仓数据</div>';
                return;
            }
            
            let totalValue = 0;
            let totalCost = 0;
            let totalRealized = 0;
            let totalUnrealized = 0;
            
            Object.values(stocks).forEach(stock => {
                const currentPrice = parseFloat(stock.price) || 0;
                const positionValue = stock.position * currentPrice;
                const positionCost = stock.position * stock.cost;
                const unrealized = positionValue - positionCost;
                
                totalValue += positionValue;
                totalCost += positionCost;
                totalRealized += stock.realizedPnL;
                totalUnrealized += unrealized;
            });
            
            const totalPnL = totalRealized + totalUnrealized;
            
            totalPnLSummary.innerHTML = `
                <div style="padding: 15px; background: #f9f9f9; border-radius: 4px;">
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                        <div>
                            <div style="margin-bottom: 8px;"><strong>总市值：</strong>¥${totalValue.toFixed(2)}</div>
                            <div style="margin-bottom: 8px;"><strong>总成本：</strong>¥${totalCost.toFixed(2)}</div>
                        </div>
                        <div>
                            <div style="margin-bottom: 8px;"><strong>已实现盈亏：</strong><span class="${totalRealized >= 0 ? 'profit' : 'loss'}">¥${totalRealized.toFixed(2)}</span></div>
                            <div style="margin-bottom: 8px;"><strong>未实现盈亏：</strong><span class="${totalUnrealized >= 0 ? 'profit' : 'loss'}">¥${totalUnrealized.toFixed(2)}</span></div>
                            <div style="margin-bottom: 8px;"><strong>总盈亏：</strong><span class="${totalPnL >= 0 ? 'profit' : 'loss'}">¥${totalPnL.toFixed(2)}</span></div>
                        </div>
                    </div>
                </div>
            `;
        }

        // 快速买入
        function quickBuy(code) {
            openQuickTradeModal(code, 'buy');
        }

        // 快速卖出
        function quickSell(code) {
            openQuickTradeModal(code, 'sell');
        }

        // 打开快速交易弹窗
        function openQuickTradeModal(code, direction) {
            const stock = stocks[code];
            if (!stock) return;
            
            currentQuickTradeStock = code;
            currentQuickTradeDirection = direction;
            
            const modal = document.getElementById('quickTradeModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalStockName = document.getElementById('modalStockName');
            const modalCurrentPosition = document.getElementById('modalCurrentPosition');
            const modalPrice = document.getElementById('modalPrice');
            const confirmBtn = document.getElementById('confirmTradeBtn');
            
            modalTitle.textContent = direction === 'buy' ? '快速买入' : '快速卖出';
            modalStockName.textContent = `${code} - ${stock.name}`;
            modalCurrentPosition.textContent = `当前持仓: ${stock.position}股`;
            modalPrice.value = stock.price !== '---' ? stock.price : '';
            
            confirmBtn.textContent = direction === 'buy' ? '确认买入' : '确认卖出';
            confirmBtn.className = direction === 'buy' ? '' : 'danger';
            
            document.getElementById('modalShares').value = '';
            modal.style.display = 'block';
        }

        // 关闭快速交易弹窗
        function closeQuickTradeModal() {
            document.getElementById('quickTradeModal').style.display = 'none';
            currentQuickTradeStock = null;
            currentQuickTradeDirection = null;
        }

        // 确认快速交易
        function confirmQuickTrade() {
            const shares = parseInt(document.getElementById('modalShares').value);
            const price = parseFloat(document.getElementById('modalPrice').value);
            
            if (!shares || shares <= 0) {
                showStatus('请输入正确的股数', 'error');
                return;
            }
            
            if (!price || price <= 0) {
                showStatus('请输入正确的价格', 'error');
                return;
            }
            
            const stock = stocks[currentQuickTradeStock];
            
            if (currentQuickTradeDirection === 'sell' && shares > stock.position) {
                showStatus(`卖出股数(${shares})不能超过当前持仓(${stock.position})`, 'error');
                return;
            }
            
            const trade = {
                id: Date.now() + Math.random(),
                direction: currentQuickTradeDirection,
                shares: shares,
                price: price,
                time: new Date().toLocaleString()
            };
            
            stock.trades.push(trade);
            calculatePosition(currentQuickTradeStock);
            
            updateStockList();
            if (selectedStock === currentQuickTradeStock) {
                updatePositionInfo();
                updateTradeHistory();
            }
            
            showStatus(`${currentQuickTradeDirection === 'buy' ? '买入' : '卖出'}交易已添加`, 'success');
            saveToStorage();
            closeQuickTradeModal();
        }

        // 保存到Excel
        function saveToExcel() {
            if (Object.keys(stocks).length === 0) {
                showStatus('没有数据可以导出', 'warning');
                return;
            }
            
            try {
                const wb = XLSX.utils.book_new();
                
                // 创建股票汇总表
                const summaryData = [
                    ['股票代码', '股票名称', '当前价格', '持仓股数', '持仓成本', '已实现盈亏', '未实现盈亏', '总盈亏']
                ];
                
                Object.values(stocks).forEach(stock => {
                    const currentPrice = parseFloat(stock.price) || 0;
                    const unrealizedPnL = stock.position * (currentPrice - stock.cost);
                    const totalPnL = stock.realizedPnL + unrealizedPnL;
                    
                    summaryData.push([
                        stock.code,
                        stock.name,
                        stock.price,
                        stock.position,
                        stock.cost.toFixed(2),
                        stock.realizedPnL.toFixed(2),
                        unrealizedPnL.toFixed(2),
                        totalPnL.toFixed(2)
                    ]);
                });
                
                const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
                XLSX.utils.book_append_sheet(wb, summaryWs, '持仓汇总');
                
                // 创建交易记录表
                const tradesData = [
                    ['股票代码', '股票名称', '交易时间', '交易方向', '股数', '价格', '金额']
                ];
                
                Object.values(stocks).forEach(stock => {
                    stock.trades.forEach(trade => {
                        tradesData.push([
                            stock.code,
                            stock.name,
                            trade.time,
                            trade.direction === 'buy' ? '买入' : '卖出',
                            trade.shares,
                            trade.price.toFixed(2),
                            (trade.shares * trade.price).toFixed(2)
                        ]);
                    });
                });
                
                const tradesWs = XLSX.utils.aoa_to_sheet(tradesData);
                XLSX.utils.book_append_sheet(wb, tradesWs, '交易记录');
                
                const fileName = `A股做T记录_${new Date().toISOString().slice(0,10)}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                showStatus('数据已导出到Excel文件', 'success');
            } catch (error) {
                showStatus('导出失败: ' + error.message, 'error');
            }
        }

        // 从Excel导入
        function loadFromExcel() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = e.target.result;
                    const wb = XLSX.read(data, {type: 'binary'});
                    
                    // 读取交易记录表
                    const tradesWs = wb.Sheets['交易记录'];
                    if (tradesWs) {
                        const tradesData = XLSX.utils.sheet_to_json(tradesWs, {header: 1});
                        
                        // 清空现有数据
                        stocks = {};
                        
                        // 跳过标题行
                        for (let i = 1; i < tradesData.length; i++) {
                            const row = tradesData[i];
                            if (row.length < 7) continue;
                            
                            const [code, name, time, direction, shares, price] = row;
                            
                            if (!stocks[code]) {
                                stocks[code] = {
                                    code: code,
                                    name: name,
                                    price: '---',
                                    position: 0,
                                    cost: 0,
                                    trades: [],
                                    realizedPnL: 0
                                };
                            }
                            
                            stocks[code].trades.push({
                                id: Date.now() + Math.random(),
                                direction: direction === '买入' ? 'buy' : 'sell',
                                shares: parseInt(shares) || 0,
                                price: parseFloat(price) || 0,
                                time: time
                            });
                        }
                        
                        // 重新计算所有持仓
                        Object.keys(stocks).forEach(code => {
                            calculatePosition(code);
                        });
                        
                        updateStockList();
                        updatePositionInfo();
                        updateTradeHistory();
                        saveToStorage();
                        
                        showStatus('数据导入成功', 'success');
                    } else {
                        showStatus('Excel文件格式不正确，找不到"交易记录"工作表', 'error');
                    }
                } catch (error) {
                    showStatus('导入失败: ' + error.message, 'error');
                }
            };
            
            reader.readAsBinaryString(file);
            fileInput.value = '';
        }

        // 点击模态框外部关闭
        window.onclick = function(event) {
            const quickModal = document.getElementById('quickTradeModal');
            const confirmModal = document.getElementById('confirmModal');
            
            if (event.target === quickModal) {
                closeQuickTradeModal();
            }
            if (event.target === confirmModal) {
                confirmAction(false);
            }
        }
    </script>


</body></html>